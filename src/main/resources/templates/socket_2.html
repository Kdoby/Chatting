<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅방 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #chat-box { border: 1px solid #ccc; width: 600px; height: 300px; overflow-y: auto; padding: 10px; }
        #message-input { width: 500px; }
        .system { color: gray; font-style: italic; }
        .chat { color: black; }
    </style>
</head>
<body>
<h2>채팅방 테스트</h2>

<div>
    <label>Access Token:
        <input type="text" id="token" placeholder="JWT Access Token 입력" style="width:400px;">
    </label>
</div>
<div>
    <label>Room ID:
        <input type="number" id="roomId" value="1">
    </label>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
</div>

<div id="chat-box"></div>

<div>
    <input type="text" id="message-input" placeholder="메시지를 입력하세요"/>
    <button onclick="sendMessage()">보내기</button>
</div>

<hr/>
<h3>REST API 테스트</h3>
<button onclick="createRoom()">방 만들기</button>
<button onclick="inviteMembers()">멤버 초대</button>
<button onclick="leaveRoom()">방 나가기</button>

<script>
    let stompClient = null;

    function getToken() {
      return document.getElementById("token").value.trim();
    }

    function connect() {
      if (stompClient && stompClient.connected) {
        console.log("이미 연결되어 있음");
        return;
      }

      const socket = new SockJS("http://localhost:8080/ws");
      stompClient = Stomp.over(socket);

      const headers = { Authorization: "Bearer " + getToken() };

      stompClient.connect(headers, frame => {
        const roomId = document.getElementById("roomId").value;
        console.log("Connected: " + frame);

        // 같은 구독이 중복되지 않도록 id 지정
        stompClient.subscribe(
          `/sub/chat/room/${roomId}`,
          message => {
            const msg = JSON.parse(message.body);
            showMessage(msg);
          },
          { id: "chat-sub-" + roomId }
        );
      });
    }

    function disconnect() {
      if (stompClient !== null) {
        stompClient.disconnect(() => {
          console.log("Disconnected");
          stompClient = null; // ✅ 연결 객체 초기화
        });
      }
    }

    function sendMessage() {
      if (!stompClient || !stompClient.connected) {
        alert("먼저 Connect 하세요!");
        return;
      }

      const roomId = document.getElementById("roomId").value;
      const content = document.getElementById("message-input").value;

      stompClient.send(
        `/pub/chat.send/${roomId}`,
        { Authorization: "Bearer " + getToken() },
        JSON.stringify({ message: content, type: "CHAT" })
      );

      document.getElementById("message-input").value = "";
    }

    function showMessage(msg) {
      const chatBox = document.getElementById("chat-box");
      const div = document.createElement("div");

      if (msg.type === "JOIN" || msg.type === "LEAVE") {
        div.className = "system";
        div.textContent = msg.message;
      } else {
        div.className = "chat";
        div.textContent = (msg.sender || "익명") + ": " + msg.message;
      }

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // --- REST API helpers ---
    async function createRoom() {
      const token = getToken();
      const body = {
        roomName: "테스트방",
        participantsId: [1, 2] // 필요에 따라 수정
      };
      const res = await fetch("http://localhost:8080/v1/chatroom", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(body)
      });
      console.log("createRoom", await res.json());
    }

    async function inviteMembers() {
      const roomId = document.getElementById("roomId").value;
      const token = getToken();
      const body = { participantsId: [66] }; // 필요에 따라 수정

      const res = await fetch(`http://localhost:8080/v1/chatroom/${roomId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(body)
      });
      console.log("inviteMembers", await res.json());
    }

    async function leaveRoom() {
      const roomId = document.getElementById("roomId").value;
      const token = getToken();
      const res = await fetch(`http://localhost:8080/v1/chatroom/${roomId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      console.log("leaveRoom", await res.json());
    }
</script>
</body>
</html>
